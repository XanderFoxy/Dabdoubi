<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Stylischer Musikplayer — Compact</title>
  <style>
    :root{
      --bg:#0b0810;
      --panel:#0f0c14;
      --accent:#9b4dff;
      --glass: rgba(255,255,255,0.04);
      --muted: #bdb6c8;
      --shadow: 0 8px 30px rgba(11,8,16,0.6);
    }

    html,body{height:100%;margin:0;background:
      radial-gradient(1200px 600px at 10% 10%, rgba(155,77,255,0.06), transparent 8%),
      radial-gradient(900px 500px at 90% 80%, rgba(0,200,255,0.02), transparent 6%),
      var(--bg);
      font-family: Inter, "Segoe UI", system-ui, Arial, sans-serif;
      color: #fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Compact floating player */
    .player {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 380px;
      max-width: calc(100% - 36px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow), 0 2px 6px rgba(155,77,255,0.08) inset;
      backdrop-filter: blur(8px) saturate(120%);
      display: grid;
      grid-template-columns: 64px 1fr 44px;
      gap: 12px;
      align-items: center;
      z-index: 9999;
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* cover with texture-like effect */
    .cover {
      width:64px;height:64px;border-radius:10px;
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.35));
      box-shadow: 0 6px 18px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.02) inset;
      overflow: hidden;
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .cover img{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .cover::after{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));
      mix-blend-mode: overlay;
      pointer-events:none;
    }

    .meta{
      display:flex;flex-direction:column;gap:6px;
      min-width:0;
    }
    .title{
      font-size:14px;font-weight:600;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      color:#fff;
      text-shadow: 0 1px 0 rgba(0,0,0,0.6);
    }
    .artist{
      font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    /* controls & waveform column */
    .controls{
      display:flex;align-items:center;gap:8px;
    }
    .btn{
      width:36px;height:36px;border-radius:8px;border:none;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.22));
      color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,0.45);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn:focus{ outline:2px solid rgba(155,77,255,0.18); }

    .play{
      width:44px;height:44px;border-radius:10px;font-size:18px;
      background: linear-gradient(180deg, var(--accent), #6b2bff);
      box-shadow: 0 8px 28px rgba(155,77,255,0.28);
      display:flex;align-items:center;justify-content:center;
    }

    .small{
      font-size:13px;padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);
      color:var(--muted);
    }

    /* progress + waveform area */
    .progress-wrap{
      grid-column: 1 / -1;
      display:flex;flex-direction:column;gap:8px;margin-top:6px;margin-left: 76px;
    }

    .progress{
      height:6px;width:100%;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:6px;position:relative;overflow:hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5) inset;
    }
    .progress .bar{
      height:100%;width:0%;background:linear-gradient(90deg, rgba(155,77,255,0.9), rgba(100,40,255,0.9));
      border-radius:6px 0 0 6px;transition:width .08s linear;
    }

    .time-row{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-left:76px; margin-top:-2px;}

    canvas.wave{
      width:100%;height:48px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.25));
      box-shadow: 0 6px 16px rgba(0,0,0,0.45);
      display:block;
      margin-left:76px;
      cursor: pointer;
    }

    /* playlist + volume small row */
    .row-bottom{
      grid-column: 1 / -1;display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:6px;margin-left:76px;
    }

    select#plist{
      background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;color:#fff;font-size:13px;
    }

    input[type="range"].vol{
      width:120px;appearance:none;background:transparent;
    }
    input[type="range"].vol::-webkit-slider-runnable-track{height:6px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));border-radius:6px;}
    input[type="range"].vol::-webkit-slider-thumb{width:12px;height:12px;border-radius:50%;background:var(--accent);-webkit-appearance:none;margin-top:-3px;box-shadow:0 2px 6px rgba(155,77,255,0.25);}
    input[type="range"].vol:focus{outline:none;}

    /* responsive */
    @media (max-width:420px){
      .player{width:calc(100% - 28px);right:14px;left:14px;grid-template-columns:56px 1fr 40px;padding:10px;}
      .cover{width:56px;height:56px}
      .progress-wrap,.time-row,canvas.wave,.row-bottom{margin-left:66px;}
    }
  </style>
</head>
<body>

  <div class="player" aria-label="Musikplayer">
    <div class="cover" title="Cover">
      <img id="coverImg" src="https://xanderfoxy.github.io/Dabdoubi/Bilder/So schön ist die Weihnacht.jpg" alt="Cover">
    </div>

    <div class="meta">
      <div class="title" id="trackTitle">So schön ist die Weihnacht</div>
      <div class="artist" id="trackArtist">XanderFoxy</div>
      <div class="controls" style="margin-top:6px;">
        <button class="btn" id="prevBtn" title="Zurück">⏮</button>
        <button class="btn play" id="playBtn" title="Play/Pause">▶</button>
        <button class="btn" id="stopBtn" title="Stop">⏹</button>
        <button class="btn" id="nextBtn" title="Vor">⏭</button>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
      <div style="font-size:11px;color:var(--muted);">Vol</div>
      <input class="vol" id="vol" type="range" min="0" max="1" step="0.01" value="1" aria-label="Lautstärke">
    </div>

    <div class="progress-wrap">
      <div class="progress" id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div class="bar" id="progressFilled"></div>
      </div>

      <canvas class="wave" id="waveCanvas" width="800" height="96" title="Wellenform anzeigen"></canvas>
      <div class="time-row"><span id="curTime">0:00</span><span id="durTime">0:00</span></div>

      <div class="row-bottom">
        <select id="plist" aria-label="Playlist">
          <option data-file="Musik/So schön ist die Weihnacht (Demo1).mp3">So schön ist die Weihnacht</option>
        </select>

        <div style="display:flex;gap:8px;align-items:center;">
          <button class="small" id="shuffleBtn" title="Shuffle aus/an">Shuffle</button>
          <button class="small" id="repeatBtn" title="Wiederholen aus/an">Repeat</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="audio" crossorigin="anonymous"></audio>

  <script>
    // Basis-URL deines GitHub-Pages-Projekts
    const BASE = 'https://xanderfoxy.github.io/Dabdoubi/';

    // Genau so benannte Dateien wie du sie geschrieben hast (bleiben unverändert sichtbar im UI)
    const trackFile = 'Musik/So schön ist die Weihnacht (Demo1).mp3';
    const coverFile = 'Bilder/So schön ist die Weihnacht.jpg';

    // Elemente
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const vol = document.getElementById('vol');
    const progressBar = document.getElementById('progressBar');
    const progressFilled = document.getElementById('progressFilled');
    const curTimeEl = document.getElementById('curTime');
    const durTimeEl = document.getElementById('durTime');
    const coverImg = document.getElementById('coverImg');
    const titleEl = document.getElementById('trackTitle');
    const plist = document.getElementById('plist');
    const waveCanvas = document.getElementById('waveCanvas');

    // Playlist array (expandable later)
    const tracks = [
      {
        title: 'So schön ist die Weihnacht',
        artist: 'XanderFoxy',
        file: trackFile,
        cover: coverFile
      }
    ];
    let idx = 0;
    let isPlaying = false;
    let rafId = null;
    let shuffle = false;
    let repeatMode = false;

    // set audio src using encodeURI to keep display names intact while making URL web-safe
    function makeUrl(path){
      // encodeURI leaves slashes intact and encodes spaces & special characters
      return BASE + encodeURI(path);
    }

    function loadTrack(i){
      const t = tracks[i];
      audio.src = makeUrl(t.file);
      coverImg.src = makeUrl(t.cover);
      titleEl.textContent = t.title;
      // update playlist select UI to show selected
      plist.selectedIndex = i;
    }

    // visual progress
    function formatTime(s){
      if(!isFinite(s)) return '0:00';
      const m = Math.floor(s/60);
      const sec = Math.floor(s%60).toString().padStart(2,'0');
      return `${m}:${sec}`;
    }

    // basic controls
    function play(){
      audio.play().catch(()=>{/* autoplay policies may block without gesture */});
      isPlaying = true;
      playBtn.textContent = '⏸';
      startVisualizer();
    }
    function pause(){
      audio.pause();
      isPlaying = false;
      playBtn.textContent = '▶';
      cancelAnimationFrame(rafId);
    }
    function stop(){
      audio.pause();
      audio.currentTime = 0;
      isPlaying = false;
      playBtn.textContent = '▶';
      updateProgress();
      cancelAnimationFrame(rafId);
    }
    function next(){
      if(tracks.length <= 1) { audio.currentTime = 0; return; }
      if(shuffle){
        idx = Math.floor(Math.random()*tracks.length);
      } else {
        idx = (idx + 1) % tracks.length;
      }
      loadTrack(idx); play();
    }
    function prev(){
      if(audio.currentTime > 3){ audio.currentTime = 0; return; }
      idx = (idx - 1 + tracks.length) % tracks.length;
      loadTrack(idx); play();
    }

    // events
    playBtn.addEventListener('click', ()=> isPlaying ? pause() : play());
    stopBtn.addEventListener('click', stop);
    nextBtn.addEventListener('click', next);
    prevBtn.addEventListener('click', prev);

    vol.addEventListener('input', ()=> audio.volume = vol.value);

    plist.addEventListener('change', ()=>{
      idx = plist.selectedIndex;
      loadTrack(idx); play();
    });

    // progress click / seek
    progressBar.addEventListener('click', (e)=>{
      const rect = progressBar.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      audio.currentTime = pct * audio.duration;
    });

    // update progress display
    function updateProgress(){
      const cur = audio.currentTime || 0;
      const dur = audio.duration || 0;
      const pct = dur ? (cur / dur) * 100 : 0;
      progressFilled.style.width = pct + '%';
      curTimeEl.textContent = formatTime(cur);
      durTimeEl.textContent = formatTime(dur);
      // set aria value
      progressBar.setAttribute('aria-valuenow', Math.floor(pct));
    }

    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', updateProgress);
    audio.addEventListener('ended', ()=>{
      if(repeatMode) { audio.currentTime = 0; play(); }
      else next();
    });

    // small toggle buttons
    document.getElementById('shuffleBtn').addEventListener('click', (e)=>{
      shuffle = !shuffle;
      e.currentTarget.style.opacity = shuffle ? 1 : 0.6;
    });
    document.getElementById('repeatBtn').addEventListener('click', (e)=>{
      repeatMode = !repeatMode;
      e.currentTarget.style.opacity = repeatMode ? 1 : 0.6;
    });

    // VISUALIZER (waveform) using WebAudio API AnalyserNode
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx, analyser, sourceNode;
    const canvas = waveCanvas;
    const ctx = canvas.getContext('2d');

    function setupAudioContext(){
      if(audioCtx) return;
      audioCtx = new AudioContext();
      sourceNode = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }

    // draw real-time waveform
    function startVisualizer(){
      setupAudioContext();
      analyser.fftSize = 2048;
      const bufferLength = analyser.fftSize;
      const dataArray = new Uint8Array(bufferLength);

      function draw(){
        rafId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);

        // clear
        const w = canvas.width = canvas.clientWidth * devicePixelRatio;
        const h = canvas.height = canvas.clientHeight * devicePixelRatio;
        ctx.clearRect(0,0,w,h);

        // background subtle texture
        const grad = ctx.createLinearGradient(0,0,0,h);
        grad.addColorStop(0, 'rgba(255,255,255,0.01)');
        grad.addColorStop(1, 'rgba(0,0,0,0.06)');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,w,h);

        // waveform path
        ctx.lineWidth = 2 * devicePixelRatio;
        // dynamic color/lighting
        const colorGrad = ctx.createLinearGradient(0,0,w,0);
        colorGrad.addColorStop(0, 'rgba(155,77,255,0.95)');
        colorGrad.addColorStop(1, 'rgba(100,40,255,0.95)');
        ctx.strokeStyle = colorGrad;
        ctx.beginPath();

        const sliceWidth = w / bufferLength;
        let x = 0;
        for(let i=0;i<bufferLength;i++){
          const v = dataArray[i] / 128.0; // normalized 0..2
          const y = (v * h / 2);
          if(i===0){ ctx.moveTo(x,y); }
          else { ctx.lineTo(x,y); }
          x += sliceWidth;
        }
        ctx.stroke();

        // subtle highlight/gloss
        ctx.globalCompositeOperation = 'lighter';
        ctx.beginPath();
        ctx.lineWidth = 0.5 * devicePixelRatio;
        ctx.strokeStyle = 'rgba(255,255,255,0.04)';
        x = 0;
        for(let i=0;i<bufferLength;i+=8){
          const v = dataArray[i] / 128.0;
          const y = (v * h / 2);
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
          x += sliceWidth * 8;
        }
        ctx.stroke();
        ctx.globalCompositeOperation = 'source-over';
      }

      if(rafId) cancelAnimationFrame(rafId);
      draw();
    }

    // click waveform to seek
    canvas.addEventListener('click', (e)=>{
      const rect = canvas.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      if(isFinite(audio.duration)) audio.currentTime = pct * audio.duration;
      updateProgress();
    });

    // initial load
    loadTrack(idx);

    // Ensure audio context resume on first user gesture (some browsers require)
    document.body.addEventListener('click', function ensureAudio(e){
      if(!audioCtx){
        try{ setupAudioContext(); }
        catch(e){ /* ignore */ }
      }
      // also resume if suspended
      if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
      document.body.removeEventListener('click', ensureAudio);
    }, { once:true });

    // keyboard accessibility: space toggles play/pause when player focused
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space' && (document.activeElement === document.body || document.activeElement === playBtn)){
        e.preventDefault();
        isPlaying ? pause() : play();
      }
    });

    // make sure canvas scales for hi-dpi
    function resizeCanvas(){
      const ratio = devicePixelRatio || 1;
      canvas.width = canvas.clientWidth * ratio;
      canvas.height = canvas.clientHeight * ratio;
    }
    window.addEventListener('resize', ()=>{ resizeCanvas(); });
    resizeCanvas();

    // preload cover image (keeps placeholder filled until real image loads)
    (new Image()).src = makeUrl(coverFile);

  </script>
</body>
</html>
